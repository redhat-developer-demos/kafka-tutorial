<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kafka in Kubernetes :: Kafka Tutorial</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/kafka-tutorial/kafka-tutorial/1.0.x/07-kubernetes.html">
    <link rel="prev" href="06-java-kstreams.html">
    <link rel="next" href="08-kafka-listeners.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-developer-demos.github.io/kafka-tutorial">Kafka Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="kafka-tutorial" data-version="1.0.x">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#downloadconfiguresources">Download &amp; Configure Tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#kafka">Install Kafka</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-topics-partitions.html">2. Topics &amp; Partitions</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-topics-partitions.html#topics">Topics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-topics-partitions.html#partitions">Partitions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-topics-partitions.html#messages">Messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-topics-partitions.html#topic-creation">Create a Topic</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-consumers-producers.html">3. Consumer &amp; Producers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-consumers-producers.html#producer">Producer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-consumers-producers.html#consumer">Consumer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-consumers-producers.html#consume-kcat">kcat Consumer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-consumers-producers.html#produce-kcat">kcat Producer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-consumers-producers.html#playingwithoffsets">kcat Offsets</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-consumers-producers.html#changingretention">Changing Retention</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-consumers-producers.html#deletetopiccontent">Delete Topic Content</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-consumers-producers.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-java-consumer-producer.html">4. Developing Consumers and Producers in Java</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-java-consumer-producer.html#producer-java">Producing messages with Java</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-java-consumer-producer.html#deploying-producer">Deploying Producer</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-java-consumer-producer.html#consumer-java">Consuming messages with Java</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-java-consumer-producer.html#deploying-consumer">Deploying Consumer</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-java-consumer-producer.html#java-cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-kstreams.html">5. Kafka Streams</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-kstreams.html#whatkstreams">What are Kafka Streams?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-kstreams.html#kstreamsconcepts">Kafka Streams Concepts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-kstreams.html#kstreamscat-tables">Kafka Streams Global Tables</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-kstreams.html#kstreamscat-windowing">Windowing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-kstreams.html#kstreamscat-timewindow">Tumbling Time Window</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-kstreams.html#kstreamscat-sessiontimewindow">Session Time Window</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-java-kstreams.html">6. Developing Kafka Streams</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-java-kstreams.html#player-songs-java">Player Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-java-kstreams.html#deploying-player-app">Deploying Player Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-java-kstreams.html#music-chart-java">Music Chart Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-java-kstreams.html#deploying-music-chart">Deploying Music Chart Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-java-kstreams.html#kstreams-cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-kubernetes.html">7. Kafka in Kubernetes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#kubernetes">Kubernetes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#install-minikube">Install Minikube</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#start-kubernetes">Start Kubernetes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#strimzi">Strimzi</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#installing-crds">Install Strimzi Operator</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#deploy-kafka">Deploy Kafka</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#deploy-service-strimzi">Deploy Services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#kubernetes-song-app">Deploy Song Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#kubernetes-song-indexer-app">Deploy Song Indexer Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#kubernetes-testing">Test It</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#kubernetes-cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">8. Tips &amp; Tricks</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-kafka-listeners.html">Kafka Listeners</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-kstreamscat.html">KStreamscat</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Kafka Tutorial</a></li>
    <li><a href="07-kubernetes.html">7. Kafka in Kubernetes</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/kafka-tutorial/edit/master/documentation/modules/ROOT/pages/07-kubernetes.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Kafka in Kubernetes</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Kubernetes is an open source container orchestration platform that automates many of the manual processes involved in deploying, managing, and scaling containerized applications.</p>
</div>
<div class="paragraph">
<p>Kubernetes is an ideal platform for hosting cloud-native applications that require rapid scaling, like real-time data streaming through Apache Kafka.</p>
</div>
<div class="paragraph">
<p>But deploying a Kafka cluster with - or in newer versions without ZooKeeper - and more than one broker, is not an easy task. It is particularly challenging to get the following three aspects right:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>networking</p>
</li>
<li>
<p>storage</p>
</li>
<li>
<p>security</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Instead of trying to manually configure everything from scratch which is both, cumbersome and error-prone, we should delegate this to Kubernetes operators. To do so, we can use <a href="https://strimzi.io/">Strimzi</a> which offers a powerful and convenient way to deploy different Kafka cluster architectures to Kubernetes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kubernetes"><a class="anchor" href="#kubernetes"></a>Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For this part of the tutorial you need a Kubernetes cluster running.</p>
</div>
<div class="sect2">
<h3 id="install-minikube"><a class="anchor" href="#install-minikube"></a>Install Minikube</h3>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_macos"></a>MacOS</p>
</li>
<li>
<p><a id="tabset1_linux"></a>Linux</p>
</li>
<li>
<p><a id="tabset1_windows"></a>Windows</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_macos">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkdir bin &amp;&amp; cd bin</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -Lo minikube <a href="https://storage.googleapis.com/minikube/releases/v1.25.1/minikube-darwin-amd64" class="bare">https://storage.googleapis.com/minikube/releases/v1.25.1/minikube-darwin-amd64</a></code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">chmod +x minikube</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -LO <a href="https://storage.googleapis.com/kubernetes-release/release/v1.23.1/bin/darwin/amd64/kubectl" class="bare">https://storage.googleapis.com/kubernetes-release/release/v1.23.1/bin/darwin/amd64/kubectl</a></code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">chmod +x kubectl</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ..</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_linux">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkdir bin &amp;&amp; cd bin</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -Lo minikube <a href="https://storage.googleapis.com/minikube/releases/v1.25.1/minikube-linux-amd64" class="bare">https://storage.googleapis.com/minikube/releases/v1.25.1/minikube-linux-amd64</a></code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">chmod +x minikube</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -LO <a href="https://storage.googleapis.com/kubernetes-release/release/v1.23.1/bin/linux/amd64/kubectl" class="bare">https://storage.googleapis.com/kubernetes-release/release/v1.23.1/bin/linux/amd64/kubectl</a></code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">chmod +x kubectl</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ..</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_windows">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkdir bin &amp;&amp; cd bin</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -Lo minikube <a href="https://storage.googleapis.com/minikube/releases/v1.25.1/minikube-windows-amd64.exe" class="bare">https://storage.googleapis.com/minikube/releases/v1.25.1/minikube-windows-amd64.exe</a></code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -LO <a href="https://storage.googleapis.com/kubernetes-release/release/v1.23.1/bin/windows/amd64/kubectl" class="bare">https://storage.googleapis.com/kubernetes-release/release/v1.23.1/bin/windows/amd64/kubectl</a></code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ..</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And then set environment variables:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_macos-and-linux"></a>MacOS and Linux</p>
</li>
<li>
<p><a id="tabset2_windows"></a>Windows</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_macos-and-linux">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-session hljs" data-lang="bash-session">export MINIKUBE_HOME=$TUTORIAL_HOME;
export PATH=$MINIKUBE_HOME/bin:$PATH
export KUBECONFIG=$MINIKUBE_HOME/.kube/config
export KUBE_EDITOR="code -w"</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_windows">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-session hljs" data-lang="bash-session">set MINIKUBE_HOME=%TUTORIAL_HOME%
set PATH=%MINIKUBE_HOME%/bin:%PATH%
set KUBECONFIG=%MINIKUBE_HOME%/.kube/config
set KUBE_EDITOR="code -w"</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="start-kubernetes"><a class="anchor" href="#start-kubernetes"></a>Start Kubernetes</h3>
<div class="paragraph">
<p>The following section shows how to start Kubernetes with required configurations:</p>
</div>
<div class="paragraph">
<p>The profile kafka is created to run the tutorial:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset3_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_minikube">
<div class="paragraph">
<p>Having <code>minikube</code> installed and in your <code>PATH</code>, then run:</p>
</div>
<div class="paragraph">
<p><strong>MacOS</strong></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">minikube start --memory=8192 --cpus=3 --kubernetes-version=v1.23.1 --vm-driver=virtualbox -p kafka</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Linux</strong></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">minikube start --memory=8192 --cpus=3 --kubernetes-version=v1.23.1 --vm-driver=kvm2 -p kafka</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Windows:</strong></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">minikube start --memory=8192 --cpus=3 --kubernetes-version=v1.23.1 --vm-driver=hyperv -p kafka</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the output must be something similar like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">üòÑ  [kafka] minikube v1.20.0 on Darwin 11.3
‚úÖ  Created a new profile : kafka
‚úÖ  minikube profile was successfully set to kafka
üòÑ  [default] minikube v1.25.1 on Darwin 11.3
‚ú®  Selecting 'virtualbox' driver from user configuration (alternates: [hyperkit])
üî•  Creating virtualbox VM (CPUs=2, Memory=8192MB, Disk=50000MB) ...
üê≥  Preparing Kubernetes v1.23.1 on Docker '20.10.6' ...
    ‚ñ™ apiserver.enable-admission-plugins=LimitRanger,NamespaceExists,NamespaceLifecycle,ResourceQuota,ServiceAccount,DefaultStorageClass,MutatingAdmissionWebhook
üöú  Pulling images ...
üöÄ  Launching Kubernetes ...
‚åõ  Waiting for cluster to come online ...
üèÑ  Done! kubectl is now configured to use "kafka"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally configure to use minikube internal docker as docker host:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">eval $(minikube docker-env -p kafka)</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_openshift">
<div class="paragraph">
<p>To run OpenShift4, you need to have one provisioned using <a href="https://try.openshift.com">try.openshift.com</a> or can use any existing OpenShift4 cluster.
Once you have your cluster, you can download the latest OpenShift client(oc) from <a href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/">here</a> and add to your path.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc version</pre>
</div>
</div>
<div class="paragraph">
<p>You can check the OpenShift version using:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc version</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should show oc version &gt;=4.7:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Client Version: 4.7.0-202102130115.p0-c66c03f
Kubernetes Version: v1.23.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then login into the OpenShift cluster using <code>oc login</code></p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="strimzi"><a class="anchor" href="#strimzi"></a>Strimzi</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Strimzi provides a way to run an Apache Kafka cluster on Kubernetes in various deployment configurations.</p>
</div>
<div class="paragraph">
<p>Some of the features of Strimzi are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Secure by Default</dt>
<dd>
<p>TLS and SCRAM-SHA supported. Automated Certificate Management.</p>
</dd>
<dt class="hdlist1">Simple yet Configurable</dt>
<dd>
<p>NodePort, Load balancer, and Ingress options. Rack awareness for HA. Use dedicated nodes for Kafka.</p>
</dd>
<dt class="hdlist1">Kubernetes-Native Experience</dt>
<dd>
<p><code>kubectl get kafka</code>. Operator Based. Manage Kafka using gitops.</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="installing-crds"><a class="anchor" href="#installing-crds"></a>Installation of Strimzi Operator</h3>
<div class="paragraph">
<p>Strimzi uses Kubernetes operators to manage the Kafka cluster.
To install the Strimzi operator you need to run the following command:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset4_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_minikube">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kubectl apply -f 'https://strimzi.io/install/latest?namespace=default' -n default</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">customresourcedefinition.apiextensions.k8s.io/kafkas.kafka.strimzi.io created
rolebinding.rbac.authorization.k8s.io/strimzi-cluster-operator-entity-operator-delegation created
clusterrolebinding.rbac.authorization.k8s.io/strimzi-cluster-operator created
rolebinding.rbac.authorization.k8s.io/strimzi-cluster-operator-topic-operator-delegation created
customresourcedefinition.apiextensions.k8s.io/kafkausers.kafka.strimzi.io created
customresourcedefinition.apiextensions.k8s.io/kafkamirrormaker2s.kafka.strimzi.io created
clusterrole.rbac.authorization.k8s.io/strimzi-entity-operator created
clusterrole.rbac.authorization.k8s.io/strimzi-cluster-operator-global created
clusterrolebinding.rbac.authorization.k8s.io/strimzi-cluster-operator-kafka-broker-delegation created
rolebinding.rbac.authorization.k8s.io/strimzi-cluster-operator created
clusterrole.rbac.authorization.k8s.io/strimzi-cluster-operator-namespaced created
clusterrole.rbac.authorization.k8s.io/strimzi-topic-operator created
serviceaccount/strimzi-cluster-operator created
clusterrole.rbac.authorization.k8s.io/strimzi-kafka-broker created
customresourcedefinition.apiextensions.k8s.io/kafkatopics.kafka.strimzi.io created
customresourcedefinition.apiextensions.k8s.io/kafkabridges.kafka.strimzi.io created
deployment.apps/strimzi-cluster-operator created
customresourcedefinition.apiextensions.k8s.io/kafkaconnectors.kafka.strimzi.io created
customresourcedefinition.apiextensions.k8s.io/kafkaconnects2is.kafka.strimzi.io created
customresourcedefinition.apiextensions.k8s.io/kafkaconnects.kafka.strimzi.io created
customresourcedefinition.apiextensions.k8s.io/kafkamirrormakers.kafka.strimzi.io created</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">NAME                                          READY   STATUS    RESTARTS   AGE
strimzi-cluster-operator-f696c85f7-9fggx      1/1     Running   0          6m53s</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_openshift">
<div class="paragraph">
<p>To install Kafka in OpenShift, you can go to <span class="menuseq"><b class="menu">Operators</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">OperatorHub</b></span> and search for <code>Kafka</code>.
Then select the <code>Red Hat Integration - AMQ Streams</code> and install it.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/amqstreams.png" alt="amqstreams">
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Check that everything has been installed by running the following commands:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kubectl get crds | grep kafka</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">NAME                                  CREATED AT
kafkabridges.kafka.strimzi.io         2022-12-19T07:16:50Z
kafkaconnectors.kafka.strimzi.io      2022-12-19T07:16:50Z
kafkaconnects.kafka.strimzi.io        2022-12-19T07:16:50Z
kafkamirrormaker2s.kafka.strimzi.io   2022-12-19T07:16:50Z
kafkamirrormakers.kafka.strimzi.io    2022-12-19T07:16:50Z
kafkarebalances.kafka.strimzi.io      2022-12-19T07:16:50Z
kafkas.kafka.strimzi.io               2022-12-19T07:16:50Z
kafkatopics.kafka.strimzi.io          2022-12-19T07:16:50Z
kafkausers.kafka.strimzi.io           2022-12-19T07:16:50Z</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploy-kafka"><a class="anchor" href="#deploy-kafka"></a>Deploying Kafka Cluster</h3>
<div class="paragraph">
<p>To deploy the cluster, you need to create a Kafka resource file using the Kafka Custom Resource Definition (<em>CRD</em>).</p>
</div>
<div class="paragraph">
<p>In this case, you are going to deploy a Kafka cluster with 3 instances and ephemeral storage.</p>
</div>
<div class="paragraph">
<p>The file you are going to apply is shown below:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    version: 3.3.1
    replicas: 3
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
      - name: tls
        port: 9093
        type: internal
        tls: true
    config:
      offsets.topic.replication.factor: 3
      transaction.state.log.replication.factor: 3
      transaction.state.log.min.isr: 2
      default.replication.factor: 3
      min.insync.replicas: 2
      inter.broker.protocol.version: "3.3"
    storage:
      type: ephemeral
  zookeeper:
    replicas: 3
    storage:
      type: ephemeral
  entityOperator:
    topicOperator: {}
    userOperator: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how simple it is to deploy a Kafka cluster in Kubernetes, you just need a few YAML lines.
Run the following command to deploy Kafka:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kubectl apply -f <a href="https://strimzi.io/examples/latest/kafka/kafka-ephemeral.yaml" class="bare">https://strimzi.io/examples/latest/kafka/kafka-ephemeral.yaml</a> -n default</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kafka.kafka.strimzi.io/my-cluster created</code></pre>
</div>
</div>
<div class="paragraph">
<p>To wait until Kafka cluster is up and running, you can run the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kubectl wait kafka/my-cluster --for=condition=Ready --timeout=300s -n default</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kafka.kafka.strimzi.io/my-cluster condition met</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that, you should have Kafka pods and services up and running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">NAME                                          READY   STATUS    RESTARTS      AGE
my-cluster-entity-operator-7dfb85ccf9-28dqd   3/3     Running   0             95s
my-cluster-kafka-0                            1/1     Running   0             118s
my-cluster-kafka-1                            1/1     Running   0             118s
my-cluster-kafka-2                            1/1     Running   0             118s
my-cluster-zookeeper-0                        1/1     Running   0             2m21s
my-cluster-zookeeper-1                        1/1     Running   0             2m21s
my-cluster-zookeeper-2                        1/1     Running   0             2m21s
strimzi-cluster-operator-f696c85f7-9fggx      1/1     Running   0             7m49s</code></pre>
</div>
</div>
<div class="paragraph">
<p>And services:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kubectl get services</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">NAME                          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                               AGE
kubernetes                    ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP                               10m33s
my-cluster-kafka-bootstrap    ClusterIP   10.98.94.157    &lt;none&gt;        9091/TCP,9092/TCP,9093/TCP            3m12s
my-cluster-kafka-brokers      ClusterIP   None            &lt;none&gt;        9090/TCP,9091/TCP,9092/TCP,9093/TCP   3m12s
my-cluster-zookeeper-client   ClusterIP   10.104.185.52   &lt;none&gt;        2181/TCP                              3m35s
my-cluster-zookeeper-nodes    ClusterIP   None            &lt;none&gt;        2181/TCP,2888/TCP,3888/TCP            3m35s</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-service-strimzi"><a class="anchor" href="#deploy-service-strimzi"></a>Deploying Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s deploy the example done at <a href="#Developing Consumers and Producers in Java">[Developing Consumers and Producers in Java]</a>, but in Kubernetes instead of Docker.
This time, the Quarkus versions of the <code>song</code> / <code>song-indexer</code> applications are deployed.</p>
</div>
<div class="sect2">
<h3 id="kubernetes-song-app"><a class="anchor" href="#kubernetes-song-app"></a>Deploy Song Service</h3>
<div class="paragraph">
<p>To deploy the <code>song-app</code> service go to its folder and build the application</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">cd $TUTORIAL_HOME/apps/song-app/quarkus/song-app
./mvnw clean package</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a successful build use <code>kubectl</code> to deploy it:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kubectl apply -f target/kubernetes/kubernetes.yml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">service/kafka-tutorial-song-app-quarkus created
deployment.apps/kafka-tutorial-song-app-quarkus created</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that the service has been deployed correctly:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">NAME                                                       READY   STATUS    RESTARTS      AGE
kafka-tutorial-song-app-quarkus-55df95589f-fg5v2           1/1     Running   0             7m23s
my-cluster-entity-operator-7dfb85ccf9-28dqd                3/3     Running   0             21m
my-cluster-kafka-0                                         1/1     Running   0             21m
my-cluster-kafka-1                                         1/1     Running   0             21m
my-cluster-kafka-2                                         1/1     Running   0             21m
my-cluster-zookeeper-0                                     1/1     Running   0             22m
my-cluster-zookeeper-1                                     1/1     Running   0             22m
my-cluster-zookeeper-2                                     1/1     Running   0             22m
strimzi-cluster-operator-f696c85f7-9fggx                   1/1     Running   0             37m49s</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-song-indexer-app"><a class="anchor" href="#kubernetes-song-indexer-app"></a>Deploy Song Indexer Service</h3>
<div class="paragraph">
<p>To deploy the <code>song-indexer-app</code> service go to its folder and build the application</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">cd $TUTORIAL_HOME/apps/song-indexer-app/quarkus/song-indexer-app
./mvnw clean package</code></pre>
</div>
</div>
<div class="paragraph">
<p>And use <code>kubectl</code> to deploy the it:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kubectl apply -f target/kubernetes/kubernetes.yml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">service/kafka-tutorial-song-indexer-app-quarkus created
deployment.apps/kafka-tutorial-song-indexer-app-quarkus created</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that the service has been deployed correctly:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">NAME                                                       READY   STATUS    RESTARTS      AGE
kafka-tutorial-song-app-quarkus-55df95589f-fg5v2           1/1     Running   0             9m21s
kafka-tutorial-song-indexer-app-quarkus-6c4b56f448-xgshm   1/1     Running   0             1m10s
my-cluster-entity-operator-7dfb85ccf9-28dqd                3/3     Running   0             23m
my-cluster-kafka-0                                         1/1     Running   0             23m
my-cluster-kafka-1                                         1/1     Running   0             23m
my-cluster-kafka-2                                         1/1     Running   0             23m
my-cluster-zookeeper-0                                     1/1     Running   0             24m
my-cluster-zookeeper-1                                     1/1     Running   0             24m
my-cluster-zookeeper-2                                     1/1     Running   0             24m
strimzi-cluster-operator-f696c85f7-9fggx                   1/1     Running   0             39m33s</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-testing"><a class="anchor" href="#kubernetes-testing"></a>Test It</h3>
<div class="paragraph">
<p>Let&#8217;s test that it works as expected.</p>
</div>
<div class="paragraph">
<p>The first thing we do is create tunnels to the corresponding services of the two applications. This can be easily done with the <code>minikube service</code> command.</p>
</div>
<div class="paragraph">
<p>In a separate terminal window run the following:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">minikube service kafka-tutorial-song-indexer-app-quarkus</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your console output should look similar (minikube IP and ports in use may vary of course). In case a browser window opens automatically you can close it because it&#8217;s not needed in our case.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">|-----------|---------------------------------|-------------|---------------------------|
| NAMESPACE |              NAME               | TARGET PORT |            URL            |
|-----------|---------------------------------|-------------|---------------------------|
| default   | kafka-tutorial-song-app-quarkus | http/80     | <a href="http://192.168.49.2:30588" class="bare">http://192.168.49.2:30588</a> |
|-----------|---------------------------------|-------------|---------------------------|
üèÉ  Starting tunnel for service kafka-tutorial-song-app-quarkus.
|-----------|---------------------------------|-------------|------------------------|
| NAMESPACE |              NAME               | TARGET PORT |          URL           |
|-----------|---------------------------------|-------------|------------------------|
| default   | kafka-tutorial-song-app-quarkus |             | <a href="http://127.0.0.1:65000" class="bare">http://127.0.0.1:65000</a> |
|-----------|---------------------------------|-------------|------------------------|
üéâ  Opening service default/kafka-tutorial-song-app-quarkus in default browser...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The important part is shown in the lower right box, namely use <code>127.0.0.1:65000</code> as host and port for any HTTP commands against the <code>song-app</code>.</p>
</div>
<div class="paragraph">
<p>Again, in a separate terminal window run the following:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">minikube service kafka-tutorial-song-indexer-app-quarkus</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your console output should look similar (minikube IP and ports in use may vary of course). In case a browser window opens automatically you can close it because it&#8217;s not needed in our case.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">|-----------|-----------------------------------------|-------------|---------------------------|
| NAMESPACE |                  NAME                   | TARGET PORT |            URL            |
|-----------|-----------------------------------------|-------------|---------------------------|
| default   | kafka-tutorial-song-indexer-app-quarkus | http/80     | <a href="http://192.168.49.2:32548" class="bare">http://192.168.49.2:32548</a> |
|-----------|-----------------------------------------|-------------|---------------------------|
üèÉ  Starting tunnel for service kafka-tutorial-song-indexer-app-quarkus.
|-----------|-----------------------------------------|-------------|------------------------|
| NAMESPACE |                  NAME                   | TARGET PORT |          URL           |
|-----------|-----------------------------------------|-------------|------------------------|
| default   | kafka-tutorial-song-indexer-app-quarkus |             | <a href="http://127.0.0.1:64938" class="bare">http://127.0.0.1:64938</a> |
|-----------|-----------------------------------------|-------------|------------------------|
üéâ  Opening service default/kafka-tutorial-song-indexer-app-quarkus in default browser...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The important part is shown in the lower right box, namely use <code>127.0.0.1:64938</code> as host and port for any HTTP commands against the <code>song-indexer-app</code>.</p>
</div>
<div class="paragraph">
<p>With the above, you successfully created tunnels to the two services and you are now ready to communicate with the applications from you host machine.</p>
</div>
<div class="paragraph">
<p>Open another 2 terminal windows, one for populating songs, and another one to get the SSE stream from the indexer service.</p>
</div>
<div class="paragraph">
<p>In the terminal 1 run the following command against the <code>song-indexer-app</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">http GET 127.0.0.1:64938/events --stream --timeout=600</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">HTTP/1.1 200 OK
Content-Type: text/event-stream
transfer-encoding: chunked</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the terminal 2 run the following command against the <code>song-app</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">http POST 127.0.0.1:65000/songs id=107 name=Portals author='Alan Silvestri'</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">HTTP/1.1 201 Created
content-length: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inspect the output of terminal 1, to check that the published song data has been processed by the <code>song-indexer-app</code>:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">id:7d92d0ed-ab04-4182-96b0-0bc4f97156c5
data:Song 107 processed</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kubernetes-cleanup"><a class="anchor" href="#kubernetes-cleanup"></a>Clean Up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To clean up the whole namespace run:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash-shell hljs" data-lang="bash-shell">kubectl delete all --all</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="06-java-kstreams.html">6. Developing Kafka Streams</a></span>
  <span class="next"><a href="08-kafka-listeners.html">Kafka Listeners</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
